% Copyright (c) 2002-2015
%       H. Turgut Uyar <uyar@itu.edu.tr>
%       Şule Gündüz Öğüdücü <sgunduz@itu.edu.tr>
%
% This work is licensed under a "Creative Commons
% Attribution-NonCommercial-ShareAlike 4.0 International License".
% For more information, please visit:
% https://creativecommons.org/licenses/by-nc-sa/4.0/

\documentclass[dvipsnames]{beamer}

\usepackage{ae}
\usepackage[scaled=0.88]{beramono}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\setbeamertemplate{navigation symbols}{}
\setbeamersize{text margin left=2em, text margin right=2em}

\usepackage{listings}
\lstdefinelanguage{Python3}[]{Python}{
  morekeywords={as, with}
}
\lstdefinelanguage{FullSQL}[]{SQL}{
  morekeywords={BINARY, BOOLEAN, CYCLE, FINAL, INCREMENT, IS, LARGE, MAXVALUE,
                MINVALUE, NO_ACTION, OBJECT, REFERENCES, RENAME, SEQUENCE,
                START, TO, TYPE, VACUUM}
}
\lstdefinelanguage{ExtendedSQL}[]{FullSQL}{
  morekeywords={AFTER, BEFORE, DO, EACH, FOR, FUNCTION, INSTEAD, LANGUAGE,
                OPTION, PROCEDURE, RETURNS, ROW, RULE, SNAPSHOT, STATEMENT,
                WITH}
}
\lstset{basicstyle=\ttfamily, keywordstyle=\color{ForestGreen},
        showstringspaces=false}

\mode<presentation>
{
  \usetheme{Warsaw}
  \usecolortheme[named=ForestGreen]{structure}
  \setbeamercovered{transparent}
}

\title{Database Systems}
\subtitle{Application Development}

\author{H. Turgut Uyar \and Şule Öğüdücü}
\date{2002-2015}

\AtBeginSubsection[]{
  \begin{frame}<beamer>
    \frametitle{Topics}
    \tableofcontents[currentsection,currentsubsection]
  \end{frame}
}

\theoremstyle{plain}

\pgfdeclareimage[width=2cm]{license}{../license}

\pgfdeclareimage[width=11cm]{xkcd}{xkcd}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\begin{frame}
  \frametitle{License}

  \pgfuseimage{license}\hfill
  \copyright~2002-2015 T. Uyar, Ş. Öğüdücü

  \vfill
  \begin{footnotesize}
    You are free to:
    \begin{itemize}
      \itemsep0em
      \item Share -- copy and redistribute the material in any medium or format
      \item Adapt -- remix, transform, and build upon the material
    \end{itemize}

    Under the following terms:
    \begin{itemize}
      \itemsep0em
      \item Attribution -- You must give appropriate credit, provide a link to
        the license, and indicate if changes were made.

      \item NonCommercial -- You may not use the material for commercial
        purposes.

      \item ShareAlike -- If you remix, transform, or build upon the material,
        you must distribute your contributions under the same license as the
        original.
    \end{itemize}
  \end{footnotesize}

  \begin{small}
    For more information:\\
    \url{https://creativecommons.org/licenses/by-nc-sa/4.0/}

    \smallskip
    Read the full license:\\
    \url{https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode}
  \end{small}
\end{frame}

\begin{frame}
  \frametitle{Topics}
  \tableofcontents
\end{frame}

\lstset{language=Python3}

\section{Database APIs}

\subsection{Introduction}

\begin{frame}
  \frametitle{Introduction}

  \begin{itemize}
    \item how to carry out data statements in application code?

    \bigskip
    \item connect to the database server
    \item provide credentials

    \medskip
    \item carry out operations
    \item adapt results

    \medskip
    \item disconnect
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Goals}

  \begin{itemize}
    \item code shouldn't be tied to a specific product
    \item code should be easy to port to another product

    \medskip
    \item abstraction layers cause performance issues
    \item for example, ODBC is standard but slow

    \pause
    \bigskip
    \item languages define standard interfaces for drivers to implement
    \item Java: JDBC, Python: DBAPI
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Python DBAPI}

  \begin{itemize}
    \item import driver module
    \item rename for easier porting to other drivers
  \end{itemize}

  \begin{exampleblock}{example}
    \begin{lstlisting}
import psycopg2 as dbapi2
# import sqlite3 as dbapi2
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Connection}

  \begin{itemize}
    \item connection info: username, password, host, port, database name

    \medskip
    \item data source name (DSN):\\
      \texttt{user=.. password=.. host=.. port=.. dbname=..}
    \item uniform resource identifier (URI):\\
      \texttt{protocol://user:password@host:port/dbname}
  \end{itemize}

  \medskip
  \begin{exampleblock}{examples}
    \begin{lstlisting}
user='vagrant' password='vagrant' host='localhost'
    port=5432 dbname='itucsdb'

postgres://vagrant:vagrant@localhost:5432/itucsdb
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Connection Example}

  \begin{lstlisting}
dsn = """user='vagrant' password='vagrant'
         host='localhost' dbname='itucsdb'"""
connection = dbapi2.connect(dsn)

# database operations

connection.close()
  \end{lstlisting}
\end{frame}

\subsection{Operations}

\begin{frame}
  \frametitle{Update Operations}

  \begin{itemize}
    \item for update operations (insert, delete, update, create, drop, \ldots)

    \bigskip
    \item create a cursor on the connection
    \item execute statement(s) on the cursor
    \item commit pending changes on the connection
    \item close the cursor
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Update Operation Example}

  \begin{lstlisting}
connection = dbapi2.connect(dsn)
cursor = connection.cursor()
statement = """CREATE TABLE PERSON (
  ID SERIAL PRIMARY KEY,
  NAME VARCHAR(40) UNIQUE NOT NULL
)"""
cursor.execute(statement)
connection.commit()
cursor.close()
connection.close()
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{Retrieve Operations}

  \begin{itemize}
    \item for retrieve operations (select)

    \bigskip
    \item create a cursor on the connection
    \item execute statement on the cursor
    \item iterate over rows on the cursor
    \item close the cursor
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Query Example}

  \begin{lstlisting}
connection = dbapi2.connect(dsn)
cursor = connection.cursor()
    statement = """SELECT TITLE, VOTES FROM MOVIE
                    WHERE (YR = 1942)"""
cursor.execute(statement)
for row in cursor:
    title, votes = row
    print('%s : %d votes' % (title, votes))
cursor.close()
connection.close()
  \end{lstlisting}
\end{frame}

\subsection{Error Handling}

\begin{frame}[fragile]
  \frametitle{Template}

  \begin{lstlisting}
connection = dbapi2.connect(dsn)
try:
    cursor = connection.cursor()
    cursor.execute(statement)
    connection.commit()
    cursor.close()
except dbapi2.DatabaseError as e:
    connection.rollback()
    raise e
finally:
    connection.close()
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Context Managers}

  \begin{itemize}
    \item in some drivers, connections are context managers: \lstinline!with!
    \item automatic commit (try), rollback (except), close (finally)

    \medskip
    \item template:
    \begin{lstlisting}
with dbapi2.connect(dsn) as connection:
    cursor = connection.cursor()
    cursor.execute(statement)
    cursor.close()
    \end{lstlisting}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Context Managers}

  \begin{itemize}
    \item in some drivers, cursors are also context managers
    \item automatic close

    \medskip
    \item template:
    \begin{lstlisting}
with dbapi2.connect(dsn) as connection:
    with connection.cursor() as cursor:
        cursor.execute(statement)
    \end{lstlisting}
  \end{itemize}
\end{frame}

\subsection{Constructing Statements}

\begin{frame}[fragile]
  \frametitle{Constructing Statements}

  \begin{itemize}
    \item unsafe to use string formatting for constructing statements
  \end{itemize}

  \medskip
  \begin{exampleblock}{bad example}
    \begin{lstlisting}
title = 'Casablanca'
year = 1942
statement = """INSERT INTO MOVIE (TITLE, YR)
                 VALUES ('%s', %d)""" % (title, year)
cursor.execute(statement)
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

\begin{frame}[fragile]
  \frametitle{SQL Injection}

  \begin{itemize}
    \item never trust inputs from outside sources
    \item \alert{SQL injection} attacks
  \end{itemize}

  \medskip
  \begin{exampleblock}{bad example}
    \begin{lstlisting}
name = input('What is your name? ')
statement = """INSERT INTO Students (Name)
                 VALUES ('%s')""" % name
cursor.execute(statement)
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

\begin{frame}[fragile]
  \frametitle{SQL Injection Example}

  \begin{center}
    \pgfuseimage{xkcd}
  \end{center}

  \vspace{-6pt}
  \lstinline[language=SQL]!INSERT INTO Students (Name)!\\
  \lstinline[language=SQL]!   VALUES ('!\alert{\lstinline!Robert'); DROP TABLE Students;-- !}
  \lstinline[language=SQL]!')!

  \lstinline[language=SQL]!INSERT INTO Students (Name)!\\
  \lstinline[language=SQL]!   VALUES ('Robert'); DROP TABLE Students;-- !
  \lstinline[language=SQL]!')!

  \begin{tiny}
    \url{http://xkcd.com/327/}
  \end{tiny}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Placeholders}

  \begin{itemize}
    \item placeholders for values
    \item different drivers use different formats:
      \lstinline!%s!, \lstinline!?!, \ldots
  \end{itemize}

  \medskip
  \begin{exampleblock}{example}
    \begin{lstlisting}
statement = """INSERT INTO MOVIE (TITLE, YR)
                 VALUES (%s, %s)"""

# INSERT INTO MOVIE (TITLE, YR) VALUES (?, ?)

cursor.execute(statement, (title, year))
    \end{lstlisting}
  \end{exampleblock}
\end{frame}

% \subsection{SQL Procedures}
%
% \lstset{language=ExtendedSQL}
%
% \begin{frame}
%   \frametitle{Stored Procedures}
%
%   \begin{itemize}
%     \item implementing functionality in the database server
%     \item languages: SQL, PL/SQL, C, \ldots
%
%     \pause
%     \bigskip
%     \item not portable
%     \item not scalable
%     \item database servers are not optimized for business logic
%     \pause
%     \item \alert{not recommended}\\
%       $\rightarrow$ implement business logic on the application server
%   \end{itemize}
% \end{frame}
%
% \begin{frame}[fragile]
%   \frametitle{Functions}
%
%   \begin{itemize}
%     \item creating a function
%     \begin{lstlisting}
% CREATE FUNCTION
%   function_name(parameter_type [, ...])
%   RETURNS return_type
%   AS function_body
%   LANGUAGE language_name
%     \end{lstlisting}
%
%     \medskip
%     \item first parameter \$1, second parameter \$2, ...
%   \end{itemize}
% \end{frame}
%
% \begin{frame}[fragile]
%   \frametitle{SQL Function Example}
%
%   \begin{itemize}
%     \item calculating new score:\\
%       \$1: old score, \$2: old votes, \$3: new vote
%
%     \medskip
%     \begin{lstlisting}
% CREATE FUNCTION NEW_SCORE(float, int, int)
%   RETURNS float
%   AS 'SELECT ($1 * $2 + $3) / ($2 + 1);'
%   LANGUAGE 'sql'
%     \end{lstlisting}
%   \end{itemize}
% \end{frame}
%
% \begin{frame}[fragile]
%   \frametitle{Triggers}
%
%   \begin{itemize}
%     \item \alert{trigger}: a function that will be automatically invoked
%       on an event
%     \item can be useful for maintaining integrity
%
%     \pause
%     \medskip
%     \item creating a trigger:
%     \smallskip
%     \begin{lstlisting}
% CREATE TRIGGER trigger_name
%   { BEFORE | AFTER } { event [ OR ... ] }
%   ON table_name
%   [ FOR [ EACH ] { ROW | STATEMENT } ]
%   EXECUTE PROCEDURE function_name(...)
%     \end{lstlisting}
%
%     \item PL/pgSQL:
%     \begin{itemize}
%       \item \lstinline!old!: tuple before the operation
%       \item \lstinline!new!: tuple after the operation
%     \end{itemize}
%   \end{itemize}
% \end{frame}
%
% \begin{frame}[fragile]
%   \frametitle{Trigger Example}
%
%   \begin{itemize}
%     \item let \lstinline!SCORE * VOTES! be kept in the \lstinline!POINTS! column
%
%     \medskip
%     \begin{lstlisting}
% CREATE FUNCTION UPDATE_MOVIE_POINTS()
%   RETURNS opaque
%   AS 'BEGIN
%       new.POINTS = new.SCORE * new.VOTES;
%       RETURN new;
%       END;'
%   LANGUAGE 'plpgsql'
%     \end{lstlisting}
%   \end{itemize}
% \end{frame}
%
% \begin{frame}[fragile]
%   \frametitle{Trigger Example}
%
%   \begin{itemize}
%     \item calculate \lstinline!POINTS! automatically on updates
%
%     \medskip
%     \begin{lstlisting}
% CREATE TRIGGER UPDATE_MOVIE
%   BEFORE INSERT OR UPDATE ON MOVIE
%   FOR EACH ROW
%   EXECUTE PROCEDURE UPDATE_MOVIE_POINTS()
%     \end{lstlisting}
%   \end{itemize}
% \end{frame}

\subsection*{References}

\begin{frame}
  \frametitle{References}

  \begin{block}{Supplementary Reading: Date}
    \begin{itemize}
%       \item Chapter 9: Integrity
%       \begin{itemize}
%         \item 9.11. Triggers (a Digression)
%       \end{itemize}

    \item Python Database API Specification v2.0:\\
      \url{https://www.python.org/dev/peps/pep-0249/}
    \end{itemize}
  \end{block}
\end{frame}

\section{Object/Relational Mapping}

\subsection{Introduction}

\begin{frame}
  \frametitle{Problem}

  \begin{itemize}
    \item mismatch between data model and software model

    \medskip
    \item data is relational: relation, tuple, foreign key, \ldots
    \item software is object-oriented: object, reference, \ldots
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Mismatch Example}

  \begin{itemize}
    \item adding an actor to a movie - SQL definitions
  \end{itemize}

  \begin{lstlisting}[language=SQL]
CREATE TABLE MOVIE (ID INTEGER PRIMARY KEY,
    TITLE VARCHAR(80) NOT NULL)

CREATE TABLE PERSON (ID INTEGER PRIMARY KEY,
    NAME VARCHAR(40) NOT NULL)

CREATE TABLE CASTING (
    MOVIEID INTEGER REFERENCES MOVIE,
    ACTORID INTEGER REFERENCES PERSON,
    PRIMARY KEY (MOVIEID, ACTORID)
)
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Mismatch Example}

  \begin{itemize}
    \item adding an actor to a movie - SQL operations
  \end{itemize}

  \begin{lstlisting}[language=SQL]
INSERT INTO MOVIE (ID, TITLE)
  VALUES (110, 'Sleepy Hollow')

INSERT INTO PERSON (ID, NAME)
  VALUES (26, 'Johnny Depp')

INSERT INTO CASTING (MOVIEID, ACTORID)
  VALUES(110, 26)
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Mismatch Example}

  \begin{itemize}
    \item adding an actor to a movie - Python definitions
  \end{itemize}

  \begin{lstlisting}
class Person:
    def __init__(self, name):
        self.name = name

class Movie:
    def __init__(self, title):
        self.title = title
        self.cast = []

    def add_actor(self, person):
        self.cast.append(person)
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Mismatch Example}

  \begin{itemize}
    \item adding an actor to a movie - Python operations
  \end{itemize}

  \begin{lstlisting}
movie = Movie('Sleepy Hollow')
actor = Person('Johnny Depp')
movie.add_actor(actor)
  \end{lstlisting}
\end{frame}

\begin{frame}
  \frametitle{Object/Relational Mapping}

  \begin{itemize}
    \item map software components to database components
  \end{itemize}
\end{frame}

\subsection{Example: SQLAlchemy}

\begin{frame}
  \frametitle{SQLAlchemy}

  \begin{itemize}
    \item wraps a JDBC connection
    \item translates the object database interface into SQL statements
  \end{itemize}
\end{frame}

\end{document}
