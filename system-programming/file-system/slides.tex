\documentclass[dvipsnames]{beamer}

\usepackage{ae}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{listings}
\usepackage{graphicx}
\lstset{language=C}

\mode<presentation>
{
  \usetheme{Frankfurt}
  \usecolortheme[named=OliveGreen]{structure}
  \setbeamercovered{transparent}
}

\title{Systems Programming}
\subtitle{User-Space File System}

\author{H. Turgut Uyar \and Åžima Uyar}
\date{2009-2011}

\AtBeginSubsection[]{
  \begin{frame}<beamer>
    \frametitle{Topics}
    \tableofcontents[currentsection,currentsubsection]
  \end{frame}
}

\pgfdeclareimage[height=6cm]{fuse_structure}{fuse_structure}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\begin{frame}
  \frametitle{Topics}
  \tableofcontents
\end{frame}

\section{User-Space Development}

\begin{frame}
  \frametitle{System Programming Levels}

  \begin{itemize}
    \item compiling the kernel:\\
      best performance, every possible functionality\\
      risky, time-consuming
    \item kernel modules:\\
      very good performance, less risky, fast development\\
      can not do everything

    \pause
    \item user-space:\\
      even less risky, fast development, can use external libraries\\
      poorer performance, can not do everything
  \end{itemize}
\end{frame}

\section{FUSE}

\subsection{Introduction}

\begin{frame}
  \frametitle{FUSE}

  \begin{itemize}
    \item Filesystem in Userspace
    \item develop a file system in user space on top of a kernel module

    \pause
    \begin{itemize}
      \item non-native filesystems (NTFS, ZFS, ...)
      \item changing data storage (SQL, ...)
      \item providing transparent functionality (compression,\\
        encryption, ...)
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{FUSE Structure}

  \begin{center}
    \pgfuseimage{fuse_structure}
  \end{center}
\end{frame}

\begin{frame}
  \frametitle{FUSE Development}

  \begin{itemize}
    \item similar to device driver development:\\
      implement system calls
    \item needed package: libfuse-dev

    \pause
    \item system calls:
    \begin{itemize}
      \item file related:\\
        open, release, read, write, getattr, unlink, ...
      \item directory related:\\
        readdir, mkdir, rmdir, ...
    \end{itemize}
  \end{itemize}
\end{frame}

\subsection{Hello, world}

\begin{frame}
  \frametitle{Example Filesystem: Hello world}

  \begin{itemize}
    \item virtual filesystem with only one directory and one file
    \item the name of the file: \texttt{hello.txt}
    \item the contents of the file: \texttt{Hello, world!}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[fuse operations]
    \begin{lstlisting}
static struct fuse_operations hello_oper = {
    .getattr = hello_getattr,
    .readdir = hello_readdir,
    .open    = hello_open,
    .read    = hello_read,
};
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}
    \begin{lstlisting}
static const char *hello_path = "/hello.txt";
static const char *hello_str = "Hello, world!\n";
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{block}{directory listing: readdir}
    \begin{lstlisting}
static int hello_readdir(
    const char *path,
    void *buf,
    fuse_fill_dir_t filler,
    off_t offset,
    struct fuse_file_info *fi
);
    \end{lstlisting}
  \end{block}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[hello\_readdir]
    \begin{lstlisting}
if (strcmp(path, "/") != 0)
    return -ENOENT;

filler(buf, ".", NULL, 0);
filler(buf, "..", NULL, 0);
filler(buf, hello_path + 1, NULL, 0);
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{block}{reading file attributes}
    \begin{lstlisting}
static int hello_getattr(
    const char *path,
    struct stat *st_data
);
    \end{lstlisting}
  \end{block}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[hello\_getattr]
    \begin{lstlisting}
memset(stbuf, 0, sizeof(struct stat));
if (strcmp(path, "/") == 0) {
    stbuf->st_mode = S_IFDIR | 0755;
    stbuf->st_nlink = 2;
}
else if (strcmp(path, hello_path) == 0) {
    stbuf->st_mode = S_IFREG | 0444;
    stbuf->st_nlink = 1;
    stbuf->st_size = strlen(hello_str);
}
else
    res = -ENOENT;
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{block}{reading from a file}
    \begin{lstlisting}
static int hello_read(
    const char *path,
    char *buf,
    size_t size,
    off_t offset,
    struct fuse_file_info *finfo
);
    \end{lstlisting}
  \end{block}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[hello\_read]
    \begin{lstlisting}
if (strcmp(path, hello_path) != 0)
    return -ENOENT;

len = strlen(hello_str);
if (offset < len) {
    if (offset + size > len)
        size = len - offset;
    memcpy(buf, hello_str + offset, size);
} else
    size = 0;

return size;
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}
  \frametitle{FUSE Development}

  \begin{itemize}
    \item compiling:\\
      \lstinline!gcc -o hello -Wall -ansi -W -std=c99 -g -ggdb!\\
      ~~~~\lstinline!-D_GNU_SOURCE -D_FILE_OFFSET_BITS=64!\\
      ~~~~\lstinline!-lfuse hello.c!

    \item mounting:\\
      \lstinline!./hello <dir>!

    \item unmounting:\\
      \lstinline!fusermount -u <dir>!

    \item running in debug mode:\\
      \lstinline!./hello -d <dir>!
  \end{itemize}
\end{frame}

\subsection{Read-Only Filesystem}

\begin{frame}
  \frametitle{Example Filesystem: ROFS}

  \begin{itemize}
    \item read-only filesystem
    \item access an underlying directory in read-only mode
    \item all read accesses are delegated to the underlying directory
    \item all write accesses are denied
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[fuse operations]
    \begin{lstlisting}
struct fuse_operations rofs_oper = {
    .getattr = rofs_getattr,
    .readdir = rofs_readdir,
    .mkdir   = rofs_mkdir,
    .unlink  = rofs_unlink,
    .rmdir   = rofs_rmdir,
    .rename  = rofs_rename,
    .open    = rofs_open,
    .read    = rofs_read,
    .write   = rofs_write,
    .release = rofs_release,
    ...
};
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[path translation]
    \begin{lstlisting}
char *rPath = malloc(sizeof(char)*
    (strlen(path) + strlen(rw_path) + 1));

strcpy(rPath, rw_path);
if (rPath[strlen(rPath)-1] == '/') {
    rPath[strlen(rPath)-1] = '\0';
}
strcat(rPath, path);

return rPath;
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[directory listing]
    \begin{lstlisting}
upath = translate_path(path);
dp = opendir(upath);  /* DIR *dp; */
free(upath);
if(dp == NULL) {
    res = -errno;
    return res;
}

/* fill in the directory info */

closedir(dp);
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[directory info]
    \begin{lstlisting}
/* struct dirent *de; */
while((de = readdir(dp)) != NULL) {
    struct stat st;
    memset(&st, 0, sizeof(st));
    st.st_ino = de->d_ino;
    st.st_mode = de->d_type << 12;
    if (filler(buf, de->d_name, &st, 0))
        break;
}
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[reading file attributes]
    \begin{lstlisting}
upath = translate_path(path);
res = lstat(upath, st_data);
free(upath);
if(res == -1) {
    return -errno;
}
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{example}[reading from a file]
    \begin{lstlisting}
upath = translate_path(path);
fd = open(upath, O_RDONLY);
free(upath);
if(fd == -1) {
    res = -errno;
    return res;
}
res = pread(fd, buf, size, offset);
if(res == -1) {
    res = -errno;
}
close(fd);
    \end{lstlisting}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \frametitle{FUSE Development}

  \begin{block}{modification operations}
    \begin{lstlisting}
static int rofs_mkdir(
    const char *path,
    mode_t mode
);

static int rofs_unlink(const char *path);

/* body */
return -EROFS;
    \end{lstlisting}
  \end{block}
\end{frame}

\begin{frame}
  \frametitle{FUSE Development}

  \begin{itemize}
    \item compiling:\\
      \lstinline!gcc -o rofs -Wall -ansi -W -std=c99 -g -ggdb!\\
      ~~~~\lstinline!-D_GNU_SOURCE -D_FILE_OFFSET_BITS=64!\\
      ~~~~\lstinline!-lfuse rofs.c!

    \item mounting:\\
      \lstinline!./rofs <rw_dir> <ro_dir>!

    \item unmounting:\\
      \lstinline!fusermount -u <ro_dir>!

    \item running in debug mode:\\
      \lstinline!./rofs -d <rw_dir> <ro_dir>!
  \end{itemize}
\end{frame}

\end{document}
